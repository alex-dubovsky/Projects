---
title: "Appendix"
output: 
  pdf_document:
    latex_engine: pdflatex
date: "2023-04-08"
---

```{r, include=FALSE}
library(readxl)
library(zoo)
library(e1071)
library(tseries)
library(urca)
library(lmtest)
library(dplyr)
library(urca)
library(knitr)
library(kableExtra)
library(ggplot2)


dataset = read_xls("/Users/alexdubovsky/Documents/Economics/Year 3/Macroeconometrics/Project_Data.xls")
Price = dataset$Value
LogPrice=log(Price)
DLPrice=diff(LogPrice)
Date = dataset$Time

length(DLPrice)
length(LogPrice)
length(Price)
length(Date)
Price = Price[-1]
LogPrice=LogPrice[-1]
Date=Date[-1]

LogPrice.in=LogPrice[1:385]
LogPrice.out=LogPrice[386:395]
DLPrice.in=DLPrice[1:385]
DLPrice.out=DLPrice[386:395]
Date.in =Date[1:385]
Date.out=Date[386:395]

insample = data.frame(Date= Date.in,
                      LogPrice=LogPrice.in,
                      Differenced=DLPrice.in)

Dateframe= data.frame(Date= Date,
                         LogPrice = LogPrice,
                      DLPrice=DLPrice)
```

#########################       TASK A        ################################
```{r}
plot(Date.in,LogPrice.in,type='l',main ="Plot of LogPrice",
     xlab="Date",ylab="LogPrice")
grid()
plot(Date.in,DLPrice.in,type='l', main="Plot of DLPrice",xlab="Date",
     ylab="Differenced Log Price")
grid()

hist(LogPrice.in,50, main="Histogram of LogPrice", xlab="Log Price")
hist(DLPrice.in,50, main="Histogram of DLPrice", xlab="Differenced Log Price")

boxplot(LogPrice.in, horizontal = TRUE,xlab="LogPrice")

boxplot(DLPrice.in, horizontal =TRUE,xlab="DLPrice")

acf(LogPrice.in)
acf(DLPrice.in)
```
```{r,include=FALSE}
skew1=skewness(LogPrice.in)
kurt1=kurtosis(LogPrice.in)

skew2=skewness(DLPrice.in)
kurt2=kurtosis(DLPrice.in)

skew=data.frame(LogPrice=skew1,DLPrice=skew2,
                row.names="Skewness")
kurt=data.frame(LogPrice=kurt1,DLPrice=kurt2,
                row.names="Kurtosis")
sum=data.frame(unclass(summary(insample$LogPrice)),unclass(summary(insample$Differenced)),
               check.names=FALSE)
colnames(sum)=c("LogPrice","DLPrice")

sum=rbind(sum,skew)
sum=rbind(sum,kurt)
```





```{r}
knitr::kable(sum,format='pipe',caption = "Summary Statistics of DLPrice and LogPrice")
```
  
  
  TASK B        
  
```{r,include=FALSE}
summary(ur.df(LogPrice.in,type='drift',lags=20,selectlags='AIC'))                   #ADF test for Log Price
summary(ur.pp(LogPrice.in, type = "Z-tau", model = "constant", lags = "short"))     #PP test for Log Price
summary(ur.kpss(LogPrice.in, type="mu", lags="short"))                              #KPSS test for Log Price

summary(ur.df(DLPrice.in,type='drift',lags=20,selectlags='AIC'))                    #ADF test for Differenced Log Price
summary(ur.pp(DLPrice.in, type = "Z-tau", model = "constant", lags = "short"))      #PP test for Differenced Log Price
summary(ur.kpss(DLPrice.in, type="mu", lags="short"))                               #KPSS test for Differenced Log Price

ADFLogPrice = summary(ur.df(LogPrice.in,type='drift',lags=20,selectlags='AIC')) 
ADFDLPRICE=summary(ur.df(DLPrice.in,type='drift',lags=20,selectlags='AIC'))  
PPLogPrice=summary(ur.pp(LogPrice.in, type = "Z-tau", model = "constant", lags = "short"))
PPDLPrice=summary(ur.pp(DLPrice.in, type = "Z-tau", model = "constant", lags = "short")) 
KPSSLogPrice = summary(ur.kpss(LogPrice.in, type="mu", lags="short"))   
KPSSDLPrice=summary(ur.kpss(DLPrice.in, type="mu", lags="short")) 

ADF = data.frame(LogPrice=round(ADFLogPrice@teststat[1],2),DLPrice=round(ADFDLPRICE@teststat[1],2),
                 "1pct"=round(ADFLogPrice@cval[1],2),"5pct"=round(ADFLogPrice@cval[3],2),"10pct"=round(ADFLogPrice@cval[5],2),
                 row.names=c("ADF"))
PP=data.frame(LogPrice=round(PPLogPrice@teststat[1],2),DLPrice=round(PPDLPrice@teststat[1],2),
              "1pct"=round(PPLogPrice@cval[1],2),"5pct"=round(PPLogPrice@cval[2],2),"10pct"=round(PPLogPrice@cval[3],2),
              row.names=c("PP"))
KPSS=data.frame(LogPrice=round(KPSSLogPrice@teststat[1],2), DLPrice=round(KPSSDLPrice@teststat[1],2),
                "1pct"=round(KPSSLogPrice@cval[1],2),"5pct"=round(KPSSLogPrice@cval[2],2),"10pct"=round(KPSSLogPrice@cval[3],2),
                row.names = c("KPSS"))

LogPriceADF=ur.df(LogPrice.in,type='drift',lags=20,selectlags='AIC')

T_stats=rbind(ADF,PP,KPSS)
TestFrame=data.frame(LogPrice="Nonstationary",DLPrice="Stationary","1pct"=NA,"5pct"=NA,"10pct"=NA,row.names = "Conclusion")
T_stats=rbind(T_stats,TestFrame)

```








```{r echo=TRUE, fig.width=9}

knitr::kable(T_stats ,"pipe",
             col.names=c("LogPrice","DLPrice","1%","5%","10%"),caption="Test Statistics for Stationarity Tests")
```



Task C
```{r,include=FALSE}
Find.Best.Model = function(DLPrice.in){
  pLag=0:5
  qLag=0:5
  np=length(pLag)
  nq=length(qLag)
  IC = matrix(data=NA,np,nq)
  for(i in 1:np){
      for(j in 1:nq){
       p= pLag[i]
       q= qLag[j]
    
    DLPriceIC= arima(DLPrice.in, order=c(p,0,q))
    IC[i,j]= AIC(DLPriceIC)
    }
  }
  idx = which(IC==min(IC),arr.ind = TRUE)
  best.p=idx[1]-1
  best.q=idx[2]-1
    return(list(best.p=best.p,best.q=best.q,IC=IC))

}
```
```{r,include=FALSE}
Find.Best.Model(DLPrice.in) 
IC=Find.Best.Model(DLPrice.in)$IC
IC=data.frame(IC)
rownames(IC)=c('0','1','2','3','4','5')
colnames(IC)=c('0','1','2','3','4','5')
```
```{r}
knitr::kable(IC,"pipe",caption = "Table of AIC")
```
#########################       TASK D        ################################
```{r,include=FALSE}
best.p=Find.Best.Model(DLPrice.in)$best.p
best.q=Find.Best.Model(DLPrice.in)$best.q

fit.best = arima(DLPrice.in,order=c(best.p,0,best.q))
print(fit.best)

my.resid = resid(fit.best)
```
```{r,include=FALSE}
plot(Date.in, my.resid, type='l', xlab="Date", ylab="", main="Plot of ARMA Residuals")
acf(my.resid)
Lag20=Box.test(my.resid,type='Ljung-Box',lag=20, fitdf=best.p+best.q)
Lag30=Box.test(my.resid,type='Ljung-Box',lag=30, fitdf=best.p+best.q)
Lag50=Box.test(my.resid,type='Ljung-Box',lag=50, fitdf=best.p+best.q)

Ljung_Box=data.frame(Lag20=Lag20$p.value,Lag30=Lag30$p.value,Lag50=Lag50$p.value,row.names = "P-value")
LBconclusion=data.frame(Lag20="Independently Distributed",Lag30="Independently Distributed",
                        Lag50="Independently Distributed",row.names = "Conclusion")
Ljung_Box=rbind(Ljung_Box,LBconclusion)
```
```{r}
knitr::kable(Ljung_Box,"pipe",caption = "Ljung-Box Test on DLPrice Residuals")

```
#########################       TASK E        #################################
```{r,include=FALSE}
forecast = predict(fit.best,n.ahead=10)
DLPriceforecast=forecast$pred
```
```{r}
matplot(cbind(DLPrice.out,DLPriceforecast),col=1:2,type='l',ylab='DLPrice',xlab = 'Time',main="Forecasts")
legend("topright",legend=c("True Value","Forecast"),col = 1:2,lty = 1:2)
grid()
```
```{r,include=FALSE}
outsample=data.frame(Date=Date.out,
                        LogPrice=LogPrice.out,
                        Differenced=DLPrice.out)

forecasterror=DLPrice.out-DLPriceforecast 
FORECAST=data.frame(Date=Date.out,
                    ForecastDLPrice=DLPriceforecast,
                    True=DLPrice.out,
                    Deviation = forecasterror)

outsamplesize = length(DLPrice.out)
MSE = sum((forecasterror^2)/outsamplesize)
print(MSE)                        
MAE = sum((abs(forecasterror))/outsamplesize)
print(MAE)
MAPE = 100*(sum(abs(forecasterror/DLPrice.out))/outsamplesize)
print(MAPE)

correctsign=rep(0,outsamplesize)
index=DLPriceforecast*DLPrice.out>0
correctsign[index]=1
pct.correctsign=sum(correctsign)/outsamplesize
print(pct.correctsign)
```

############################# TASK F ##########################################

```{r,include=FALSE}

library(fredr)

fredr_set_key("1a594be7f2e4daca274626ccd63c7038")

series_ids <- c("PIEAFD01GBM661N")
start_date=as.Date("2009-01-01")
end_date=as.Date("2022-01-01")

cointegrationdata <- data.frame()
Stationarity=data.frame()
Stationarity2=data.frame("1pct"=c("-3.44","-3.449","0.347"),
                                  "5pct"=c("-2.87","-2.87",0.463),
                         "10pct"=c("-2.57","-2.57","0.574"),row.names = c("ADF","PP","KPSS"))
LogPrice.in2=LogPrice.in[228:384]
for (series_id in series_ids) {
  data <- fredr(series_id,
                observation_start = start_date,
                observation_end = end_date)
  reg=lm(LogPrice.in2~log(data$value))
  residual=reg$residuals
  coresid=summary(ur.df(residual,type = "none",lags=20,selectlags = "AIC"))
  
  print(paste("series_id:", series_id))
  print("coresid@teststat[1]:")
  print(coresid@teststat[1])
  
  cointegrationdata=rbind(cointegrationdata,data.frame(variable=series_id,teststat=coresid@teststat[1]))
  KPSSStationary=summary(ur.kpss(log(data$value),type="mu",lags="short"))  
  PPStationary=summary(ur.pp(log(data$value),type = "Z-tau", model = "constant", lags = "short"))
  ADFStationary=summary(ur.df(log(data$value),type="drift",lags=20,selectlags = "AIC"))
  Stationarity=data.frame(LogFood=rbind(ADFStationary@teststat[1],PPStationary@teststat[1],KPSSStationary@teststat[1]),row.names = c("ADF","PP","KPSS"))
  Stationarity2=cbind(Stationarity2,Stationarity)
}
COCV=data.frame("1pct"=-4.07,"5pct"=-3.37,"10pct"=-3.03,Hypothesis="Reject",Conclusion="stationary")
cointegrationdata=cbind(cointegrationdata,COCV)
```{r}
knitr::kable(cointegrationdata,"pipe",
             col.names=c("Series_id","T-value","1%","5%","10%","Hypothesis","Conclusion"),caption="Cointegration Test: LogPrice and LogFood")
knitr::kable(Stationarity2,"pipe",
             col.names = c("1%","5%","10%","LogFood"),caption="Stationarity Tests for LogFood")  
```

```{r,include=FALSE}
LogFood <- fredr("PIEAFD01GBM661N",
              observation_start = start_date,
              observation_end = end_date)
LogFood$value=log(LogFood$value)
```
```{r}
plot(LogFood$date,LogFood$value,type='l',
     xlab="Date",
     ylab="LogFood",
     main="Plot of LogFood")
    grid()
```
```{r,include=FALSE}
library(quantmod)
length(LogPrice.in2)
length(LogFood$value)
Logfood=LogFood$value
DLFood=diff(Logfood)
DLPrice.in2=diff(LogPrice.in2)

summary(ur.kpss(DLFood,type="mu",lags="short"))  
summary(ur.pp(DLFood,type = "Z-tau", model = "constant", lags = "short"))
summary(ur.df(DLFood,type="drift",lags=20,selectlags = "AIC"))
plot(LogFood$date[-1], DLFood,type='l')

DLFood.lag1=Lag(DLFood,k=1)
DLFood.lag2=Lag(DLFood,k=2)
DLPrice.lag1=Lag(DLPrice.in2,k=1)
DLPrice.lag2=Lag(DLPrice.in2,k=2)
residual.lag1=Lag(residual[-1],k=1)
ecm=summary(ECM.general<-lm(DLPrice.in2~DLPrice.lag1+DLPrice.lag2+DLFood+DLFood.lag1+DLFood.lag2+residual.lag1))

D2LPrice=diff(DLPrice.in2)
D2LogFood=diff(DLFood)
summary(ur.kpss(D2LogFood,type="mu",lags="short"))  
summary(ur.pp(D2LogFood,type = "Z-tau", model = "constant", lags = "short"))
summary(ur.df(D2LogFood,type="drift",lags=20,selectlags = "AIC"))
```
```{r}
knitr::kable(ecm$coefficients,'pipe',caption="Error Correction Model Coefficients")
```

